(window.webpackJsonp=window.webpackJsonp||[]).push([[115],{296:function(t,a,s){"use strict";s.r(a);var e=s(3),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"webpack-编译流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#webpack-编译流程"}},[t._v("#")]),t._v(" webpack 编译流程")]),t._v(" "),s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("weback 在 web 构建工具的激烈竞争中逐渐脱引而出。 无论是编译速度、报错提示、可扩展性等都给前端开发者耳目一新的感觉。本篇文章是个人对 webpack 的一点小研究总结。")]),t._v(" "),s("p",[t._v("webpack 在开发者社区的反馈\n类似 gulp 把自己定位为 stream building tools 一样，webpack 把自己定位为 module building system。\n在 webpack 看来，所以的文件都是模块，只是处理的方式依赖不同的工具而已。")]),t._v(" "),s("p",[t._v("webpack 同时也把 node 的 IO 和 module system 发挥的淋漓尽致。 webpack 在配合"),s("code",[t._v("babel(ES6/7)")]),t._v("和"),s("code",[t._v("tsc(typescript)")]),t._v("等类似 DSL 语言预编译工具的时候，驾轻就熟，为开发者带来了几乎完美的体验。")]),t._v(" "),s("ul",[s("li",[t._v("webpack 整体架构(以 webpack.config 主要部分进行划分)")]),t._v(" "),s("li",[t._v("entry: 定义整个编译过程的起点")]),t._v(" "),s("li",[t._v("output: 定义整个编译过程的终点")]),t._v(" "),s("li",[t._v("module: 定义模块 module 的处理方式")]),t._v(" "),s("li",[t._v("plugin 对编译完成后的内容进行二度加工")]),t._v(" "),s("li",[t._v("resolve.alias 定义模块的别名")])]),t._v(" "),s("h2",{attrs:{id:"webpack-的核心-module"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#webpack-的核心-module"}},[t._v("#")]),t._v(" webpack 的核心 module")]),t._v(" "),s("p",[t._v("无论你是"),s("code",[t._v("jsx,tsx,html,css,scss,less,png")]),t._v("文件，webpack 一视同仁为 module。并且每个文件"),s("code",[t._v("[module]")]),t._v("都会经过相同的编译工序 "),s("code",[t._v("loader==> plugin")]),t._v("。")]),t._v(" "),s("p",[t._v("关于以上这点，以如下一个简单的"),s("code",[t._v("webpack.config")]),t._v("文件为例。看下 webpack 会做什么")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  watch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  entry"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./index.js"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  devtool"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"source-map"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  output"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cwd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dist/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[name].js"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  resolve"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    alias"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" jquery"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"src/lib/jquery.js"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  plugins"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("webpack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProvidePlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      $"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jquery"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      _"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"underscore"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebpackNotifierPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  module"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    loaders"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.js[x]?$/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        exclude"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/node_modules/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        loader"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"babel-loader"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.less$/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        loaders"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"style-loader"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"css-loader"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"less-loader"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.(png|jpg|gif|woff|woff2|ttf|eot|svg|swf)$/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        loader"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"file-loader?name=[name]_[sha512:hash:base64:7].[ext]"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        test"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.html/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        loader"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"html-loader?"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("stringify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" minimize"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"webpack-是如何处理如上webpack-config文件解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#webpack-是如何处理如上webpack-config文件解析"}},[t._v("#")]),t._v(" webpack 是如何处理如上"),s("code",[t._v("webpack.config")]),t._v("文件解析")]),t._v(" "),s("ol",[s("li",[t._v("确定 webpack 编译上下文 context")])]),t._v(" "),s("p",[t._v("默认情况下就是 node 启动的工作目录"),s("code",[t._v("process.cwd()")]),t._v("，当然也可以在配置中手动指定 context。")]),t._v(" "),s("p",[t._v("webpack 在确定"),s("code",[t._v("webpack.config")]),t._v("中 entry 的路径依赖时，会根据这个 context 确定每个要编译的文件(assets)的绝对路径。")]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("entry 和 output 确定 webpack 的编译起点和终点")])]),t._v(" "),s("p",[t._v("顾名思义，entry 定义 webpack 编译起点，入口模块。 对应的结果为"),s("code",[t._v("compolation.assets")])]),t._v(" "),s("p",[t._v("output 定义 webpack 编译的终点，导出目录")]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[s("code",[t._v("module.loaders")]),t._v(" 和 "),s("code",[t._v("module.test")]),t._v(" 确定模块预编译处理方式")])]),t._v(" "),s("p",[t._v("以 babel 为例，当 webpack 发现模块名称匹配 test 中的正则"),s("code",[t._v("/js[x]?")]),t._v("的时候。")]),t._v(" "),s("p",[t._v("它会将当前模块作为参数传入 babel 函数处理，babel([当前模块资源的引用])。")]),t._v(" "),s("p",[t._v("函数执行的结果将会缓存在 webpack 的 compilation 对象上，并分配唯一的 id 。")]),t._v(" "),s("p",[t._v("以上的这一步，非常非常关键。唯一的 id 值决定了 webpack 在最后的编译结果中，是否会存在重复代码。\n而缓存在 compilation 对象上，则决定了 webpack 可以在 plugin 阶段直接拿取模块资源进行二度加工。")]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[t._v("plugin 阶段贯穿于 webpack 的整个编译流程，一般用来做一些优化操作。")])]),t._v(" "),s("p",[t._v("比如"),s("code",[t._v("webpack.ProvidePlugin")]),t._v("，它会在对编译结果再加工的操作过程中进行自定义的变量注入，当模块中碰到比如"),s("code",[t._v("_")]),t._v("这个变量的时候，webpack 将从缓存的 module 中取出 underscore 模块加载进引用"),s("code",[t._v("_")]),t._v("的文件("),s("code",[t._v("compilation.assets")]),t._v(")。")]),t._v(" "),s("p",[t._v("比如 WebpackNotifierPlugin，它会在编译结果 ready 的时通知开发者，output 已经就绪。")]),t._v(" "),s("ol",{attrs:{start:"5"}},[s("li",[s("code",[t._v("resolve.alias")]),t._v("的作用就是对 module 模块提供别名，并没有什么特殊的。")])]),t._v(" "),s("h2",{attrs:{id:"【副作用】-webpack-编译过程中的电脑卡慢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#【副作用】-webpack-编译过程中的电脑卡慢"}},[t._v("#")]),t._v(" 【副作用】 webpack 编译过程中的电脑卡慢")]),t._v(" "),s("p",[t._v("在 weback 经历以上流程的时候，查看你的内存，你会发现，内存飙升！！！")]),t._v(" "),s("p",[t._v("这一般都是 loader 阶段，对 DSL 进行 AST 抽象语法树分析的时候，由于大量应用递归，内存溢出的情\n况也是非常常见。")]),t._v(" "),s("p",[t._v("output 目录不是一个渐进的编译目录，只有在最后 compilation 结果 ready 的时候，才会写入，造成开发者等待的时候，output 目录始终为空。")]),t._v(" "),s("h2",{attrs:{id:"【webpack-编译对象-compilation】-webpack-将编译结果导出到-output-是怎么做到的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#【webpack-编译对象-compilation】-webpack-将编译结果导出到-output-是怎么做到的"}},[t._v("#")]),t._v(" 【webpack 编译对象 compilation】 webpack 将编译结果导出到 output 是怎么做到的")]),t._v(" "),s("p",[t._v("如上，webpack 在 plugin 结束前，将会在内存中生成一个 compilation 对象文件模块 tree。")]),t._v(" "),s("p",[t._v("这个阶段是 webpack 的 done 阶段: webpack 写入 output 目录的分割点。")]),t._v(" "),s("p",[t._v("这棵树的枝叶节点就是所有的 module[由 import 或者 require 为标志，并配备唯一 moduleId],")]),t._v(" "),s("p",[t._v("这棵树的主枝干就是所有的 assets，也就是我们最后需要写入到"),s("code",[t._v("output.path")]),t._v("文件夹里的文件内容。")]),t._v(" "),s("p",[t._v("最后，这个 compilation 对象也是所有 webpackPlugin 的处理的时候的 arguments。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("对于开发者来说，整体而言 webpack 的编译过程细节比较多，但是大体的框架还是比较直观。")]),t._v(" "),s("p",[t._v("里面涉及到的类似 DSL，AST 的概念及模块缓存等等，在构建工具中还是比较常见的，配合 watch 模式，debug 模式，对于开发者来说实在是一大利器。")]),t._v(" "),s("p",[t._v("一切文件皆为模块也和 react 的一切 dom 都可以变为 JS 一样，对前端世界带来了新的开发理念。")]),t._v(" "),s("blockquote",[s("p",[t._v("原文地址："),s("a",{attrs:{href:"https://github.com/slashhuang/blog/issues/1",target:"_blank",rel:"noopener noreferrer"}},[t._v("webpack编译流程漫谈"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=n.exports}}]);